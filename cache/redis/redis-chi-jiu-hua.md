# Redis 持久化

## Redis 提供了两种持久化机制： RDB 和 AOF

### RDB

1. 默认开启，会按照配置的指定时间将内存中的数据快照到磁盘中，创建一个 dump.rdb 文件，redis 启动时再恢复到内存中。
2. redis 会单独创建 fork\(\) 子进程，将当前父进程的数据库数据复制到子进程的内存中，然后由子进程写入临时文件中，持久化的过程就结束了，再用这个临时文件替换上次的快照文件，然后子进程退出，内存释放。
3. 需要注意的是，每次快照持久化都会将主进程的数据库数据复制一遍，导致内存开销加倍，若此时内存不足，则会阻塞服务器的运行，直到复制结束释放内存；都会将内存数据完整写入磁盘一次，所以如果数据量大的话，而且写操作频繁，必然会引起大量的磁盘 I/O 操作，严重影响性能，并且最后一次持久化后的数据可能会丢失。

### AOF

1. 以日志的形式记录每个写操作（读操作不记录）只追加文件但不可以改文件，redis 启动时会根据日志从头到尾全部执行一遍以完成数据的恢复工作。包括 flushDB 也会执行。
2. 主要有两种方式触发：有写操作就写，每秒定时（也会有丢数据）。
3. 因为 AOF 采用追加的方式，所以文件会越来越大，正对这个问题，新增了重写机制，就是当日志文件达到一定程度的时候，会 fork 出一条新进程来遍历进程内存中的数据，每条记录对应一条 set 语句，写到临时文件中，然后再替换到旧日志文件（类似 rdb 的操作方式）。默认触发是当 AOF 文件大小是上次重写后大小的一倍且文件大于 64 M 时触发。

当两种方式同时开启时，数据恢复 redis 会优先选择 AOF 恢复。一般情况下，只要使用默认开启的 RDB 即可，因为相对于 AOF，RDB 便于进行数据备份，并且恢复数据集的速度也要快很多。

开启持久化缓存机制，对性能会有影响，特别是当设置的内存满的时候，所以如果只是用来做缓存的话，可以关掉持久化。

[https://my.oschina.net/u/4052893/blog/2991533](https://my.oschina.net/u/4052893/blog/2991533)

