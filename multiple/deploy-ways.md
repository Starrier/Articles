---
title: deploy-ways
date: 2019-03-02 09:41:26
tags: DevOps
index_img: ../post_img/deploy-ways.jpeg
---

# 发布方法

## 蓝绿部署（Blue/Green Deployment）

使用蓝绿部署来进行热部署时，可以保证部署的安全性和可靠性。它以一种可预测的方式发布应用，目的是减少发布过程中服务停止的时间。蓝绿部署原理是通过冗余来解决问题。通常生产环境需要两组配置（蓝绿配置），一组是 active 生产环境（绿环境），一组是 inactive 的配置（蓝配置）。用户只会访问到 active 的服务器。在绿色环境运行当前生产环境中的应用，也就是旧版本应用 version1。在进行版本升级时，在蓝色环境中升级，即部署新版本并进行测试，如果没有问题，就可以把负载均衡，反向路由指向蓝色环境。随后进行环境监测，如果 version2 运行正常就可以删除 version1，如果存在问题，可以通过负载均衡进行版本回退，退回绿色环境中。

蓝绿部署无需停机，风险较小：

 1. 部署 version1 应用，所有外部请求的流量都转入这个版本上。
 2. 部署 version2 应用，version2 的代码与 version1 不同
 3. 将流量从 version1 切换至 version2。
 4. 如果 version2 测试正常，监控无异常，则可以一直使用 version2 作为正式版。

部署过程中，应用始终在线。而且，没有修改老版本的任何内容，在部署期间，老版本的状态不受影响，这样风险很小，并且，只要老版本的资源不被删除，理论上，可以回滚到任意之前的版本。

蓝绿部署的缺点：

 1. 当切换到蓝色环境时，需要妥当处理未完成的业务和新业务时。如果数据库后端无法处理，会是一个比较麻烦的问题。
 2. 有可能会出现需要同时处理微服务架构和传统架构应用的情况。如果在蓝绿部署中协调不好这两者，还可能导致服务停止。
 3. 需要提前考虑数据库与应用部署同步迁移/回滚的问题。
 4. 蓝绿部署需要有基础设施支持。
 5. 在非隔离基础架构（VM/Docker等）上执行蓝绿部署时，蓝色环境和绿色环境有被摧毁的风险。
 6. 存在额外的维护、配置成本，以及服务本身运行的开销。

蓝绿部署适用的场景：

 1. 不停止老版本，额外开发一套新版本，等版本测试发现新版本正常运行后，删除老版本。
 2. 蓝绿发布是一种适用于升级与更新的发布策略，部署的最小维度是容器，而发布的最小维度是应用。
 3. 蓝绿发布对于增量升级有比较好的支持，但是对于涉及书籍表结构变更等不可逆的升级，并不完全适用于蓝绿发布来实现，需要结合一些业务逻辑以及数据迁移与回滚策略才可以完全满足需求。

## AB 测试

AB 测试和蓝绿发布不同，AB 测试是用来测试应用功能表现的方法，例如可用性、受欢迎程度，可见性等。蓝绿发布的目的是安全稳定地发布新版本应用，并在必要时回滚。

AB 测试与蓝绿部署的区别在于，AB 测试的目的在于通过科学的设计，采样样本代表性、流量分割和小流量等方式来获得具有代表性的实验结论，并确信该结论在推广到全流量可信。

## 灰度发布/金丝雀发布

灰度发布是指在黑与白之间，能够平滑过渡的一种发布方式。灰度发布是增量发布的一种类型，灰度发布是在原有版本可用的情况下，同时部署一个新版本应用作为“金丝雀”（金丝雀对瓦斯极度敏感，矿井工人携带金丝雀，以便及时发现危险），测试新版本的性能和表现，以保障整体系统稳定的情况下，尽早发现，调整问题。

灰度发布/金丝雀发布由以下几个步骤：

 1. 准备好部署各个阶段的工作，包括：构建工件，测试脚本，配置文件和部署清单文件。
 2. 从负载均衡列表中移除掉“金丝雀”服务器。
 3. 升级“金丝雀”应用（排除掉原有流量并进行部署）
 4. 对应用进行自动化测试。
 5. 将“金丝雀”服务器重新添加到负载均衡列表中（连通性和健康检查）。
 6. 如果金丝雀在线使用测试成功，升级剩余其他服务器（否则回滚）
 
灰度发布可以保证系统的稳定性，在初始灰度的时候就可以发现，调整问题，以保证其影响度。

适用场景：

 1. 不停止老版本，额外开发一套新版本，不同版本应用共存。
 2. 灰度发布中，常常按照用户设置路由权重，例如 90% 的用户维持老版本，10% 的用户尝试新版本。
 3. 经常与 AB 测试一起使用，用于测试选择多种方案。AB 测试就是一种灰度发布方式，让一部分用户继续用 A，一部分用户开始使用B，如果用户对 B 没有什么反对意见，那么就扩大范围。

## 滚动发布

一般是取出一个或者多个服务器停止服务，执行更新，并重新将其投入使用，周而复始，直到集群中所有的实例都更新成新版本。这种部署方式相对于蓝绿部署，更加节约资源 —— 它不需要运行两个集群，两倍的实例。我们可以部分部署，比如，每次只取出集群中的 20% 进行升级。

缺点：

 1. 没有一个确定的环境。使用蓝绿部署，可以确定旧环境是稳定的，而使用滚动时，无法确定。
 2. 修改了现有环境。
 3. 无法回滚，或回滚困难。
 4. 系统不支持动态扩容。

## 红黑部署

这是 Netflix 采用的部署手段，Netflix 的主要基础设施是在 AWS 上，所以它利用 AWS 的特性，在部署新的版本时，通过 AutoScaling Group 用包含新版本应用的 AMI 的 LaunchConfiguration 创建新的服务器。测试不通过，找到问题原因后，直接干掉新生成的服务器以及 Autoscaling Group 就可以，测试通过，则将 ELB 指向新的服务器集群，然后销毁掉旧的服务器集群以及 AutoScaling Group。

红黑部署的好处是服务始终在线，同时采用不可变部署的方式，也不像蓝绿部署一样得保持冗余的服务始终在线。