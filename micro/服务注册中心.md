# 微服务注册中心

## 作用

服务注册中心，本质上是为了解耦服务提供者和服务消费者。对于任何一个微服务，原则上都应存在或者支持多个提供者，这是由微服务的分布式属性决定的。更进一步，为了支持弹性扩缩容特性，一个微服务的提供者的数量和分布往往是动态变化的，也是无法预先确定的。因此，原本在单体应用阶段常用的静态LB机制就不再适用了，需要引入额外的组件来管理微服务提供者的注册与发现，而这个组件就是服务注册中心。

服务注册中心，应该考虑其服务注册与发现机制，主要有：

1. 应用内：直接集成到应用中，依赖于应用自身完成服务的注册与发现，最典型的是 Netflix 提供的Eureka

2. 应用外：把应用当成黑盒，通过应用外的某种机制将服务注册到注册中心，最小化对应用的侵入性，比如 Airbnb 的SmartStack，HashiCorp的Consul

3. DNS：将服务注册为DNS的SRV记录，严格来说，是一种特殊的应用外注册方式，SkyDNS是其中的代表

> 1. 对于第一类注册方式，除了Eureka这种一站式解决方案，还可以基于ZooKeeper或者Etcd自行实现一套服务注册机制，这在大公司比较常见，但对于小公司而言显然性价比太低。
2. 由于DNS固有的缓存缺陷，本文不对第三类注册方式作深入探讨。

除了基本的服务注册与发现机制，从开发和运维角度，至少还要考虑如下五个方面：

- 测活：服务注册之后，如何对服务进行测活以保证服务的可用性？

- 负载均衡：当存在多个服务提供者时，如何均衡各个提供者的负载？

- 集成：在服务提供端或者调用端，如何集成注册中心？

- 运行时依赖：引入注册中心之后，对应用的运行时环境有何影响？

- 可用性：如何保证注册中心本身的可用性，特别是消除单点故障？

## Eureka

从设计角度来看，Eureka可以说是无懈可击，注册中心、提供者、调用者边界清晰，通过去中心化的集群支持保证了注册中心的整体可用性，

但缺点是Eureka属于应用内的注册方式，对应用的侵入性太强，且只支持Java应用。

## Consul

Consul本质上属于应用外的注册方式，但可以通过SDK简化注册流程。而服务发现恰好相反，默认依赖于SDK，但可以通过Consul Template（下文会提到）去除SDK依赖。

方案
最终我们选择了Consul作为服务注册中心的实现方案，主要原因有两点：

最小化对已有应用的侵入性，这也是贯穿我们整个微服务化改造的原则之一

降低运维的复杂度，Consul Agent既可以运行在服务器模式，又可以运行在客户端模式

Consul Template
上文提到使用Consul，默认服务调用者需要依赖Consul SDK来发现服务，这就无法保证对应用的零侵入性。所幸通过Consul Template，可以定时从Consul集群获取最新的服务提供者列表并刷新LB配置（比如nginx的upstream），这样对于服务调用者而言，只需要配置一个统一的服务调用地址即可。改造后的调用关系如下：


| Feature| 	Consul| 	zookeeper	| etcd	| euerka| 
| ---| ---| ---| ---| ---| 
| 服务健康检查| 	服务状态，内存，硬盘等	(弱)长连接，keepalive	连接心跳	可配支持
| 多数据中心| 	支持| 	—	| —	| —| 
| kv存储服务| 	支持| 	支持	| 支持| 	—| 
| 一致性| 	raft| 	paxos	| raft| 	—| 
| cap| 	ca	| cp| 	cp| 	ap| 
| 使用接口(多语言能力)| 	支持http和dns| 	客户端| 	http/grpc| 	http（sidecar）| 
| watch支持| 	全量/支持long polling	| 支持| 	支持 long polling	| 支持 long polling/大部分增量| 
| 自身监控| 	metrics| 	—| 	metrics| 	metrics| 
| 安全	| acl /https| 	acl| 	https支持（弱）	| —| 
| spring cloud集成| 	已支持| 	已支持| 	已支持| 	已支持| 
