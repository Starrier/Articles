---
title: netty-reactor
date: 2019-03-03 08:27:31
tags: netty
index_img: ../post_img/netty-reactor.jpeg
---

## Netty Reactor

> **Reactor**模式基于事件驱动，特别适合处理海量 IO 事件。

### 单线程模型

Reactor 单线程模型，指的是所有的 IO 操作都在同一个 NIO 线程上完成，NIO 线程的职责如下：

 1. 作为 NIO 服务端，接受客户端的 TCP 连接：
 2. 作为 NIO 客户端，向服务端发送 TCP 连接：
 3. 读取通信对端的请求或者应答消息：
 4. 向通信对端发送消息请求或者应答消息。

![single-thread](../_posts/netty-reactor/1.jpeg)

Reactor 模式使用的是异步非阻塞 IO，所有的 IO 操作都不会导致阻塞，理论上一个线程可以独立处理所有 IO 相关操作。从架构层面，一个 NIO 线程确实可以完成其所承担的职责。例如，通过 Acceptor 类接收客户端的 TCP 连接请求，链路建立后，通过 Dispatch 将相应的 ByteBuffer 派发到指定的 Handler 上进行消息解码。用户线程可以通过消息编码将 NIO 线程消息发送至客户端。

单线程不适用于高负载场景：

  1. 一个 NIO 线程同时处理成百上千的链路，性能上无法支撑，即使 NIO 线程的 CPU 负荷为 100，也无法满足海量消息编码、解码、读取和发送。
  2. 当 NIO 线程负载过重之后，处理速度将变慢，这会导致大量客户端链接超时，超时之后往往会进行重发，这加重了 NIO 线程的负载，最终导致大量消息积压和处理超时，成为系统的性能瓶颈。
  3. 可靠性问题：一旦 NIO 线程意外发生或者进入死循环，会导致整个系统通信模块不可用，不能接收和处理外部消息，造成节点故障。

### 多线程模型

Reactor 多线程模型与单线程模型的最大区别是有一组 NIO 线程处理 IO 操作，原理图：

![JVM-MM](../_posts/netty-reactor/2.png)

Reactor 多线程模型特点：

 1. 有专门一个 NIO 线程 Accept 线程用于监听服务端，接收客户端 TCP 连接请求。
 2. 网络 IO 操作读、写等由一个 NIO 线程池负责，线程池可以采用标准的 JDK 线层池实现，它包含一个任务队列和 N 个可用的线程，由这些 NIO 线程负责消息的读取、解码、编码和发送。
 3. 1 个 NIO 线程可以同时处理 N 条链路，但 1 个链路只对应 1 个 NIO 线程，防止发生并发操作问题。

在绝大多数场景下，Reactor 多线程模型都可以满足性能需求；但是，在极个别特殊场景中，一个 NIO 线程负责监听和处理所有的客户端连接可能会存在性能问题。例如并发百万客户端连接，或者服务端需要对客户端握手进行安全认证，但是认证本身非常损耗性能。在这类场景下，单独一个 Acceptor 线程可能会存在性能不足问题，为了解决性能问题，产生了第三种 Reactor 线程模型 —— 主从 Reactor 多线程模型。

### 主从多线程模型

主 Reactor 线程模型的特点是：服务端用于接收客户端连接的不再是 1 个单独的 NIO 线程，而是一个独立的 NIO 线程池。Acceptor 接收到客户端 TCP 连接请求处理完成后（可能包含接入认证等），将新创建的 SocketChannel 注册到 IO 线程池（sub reactor 线程池）的某个 IO 线程上，由它负责 SocketChannel 的读写和编码工作。Acceptor 线程池仅仅只用于客户端的登录、握手和安全认证，一旦链路建立成功，就将链路注册到后端 subReactor 线程池的 IO 线程上，由 IO 线程负责后续的 IO 操作。

![JVM-MM](../_posts/netty-reactor/3.png)

利用从 NIO 线程模型，可以解决 1 个服务端监听线程无法有效处理所有客户端链接的性能不足的瓶颈。

工作流：

 1. 从主线程池中随机选择一个 Reactor 线程作为 Acceptor 线程，用于绑定监听端口，接受客户端连接：
 2. Acceptor 线程接收客户端请求之后创建新的 SocketChannel，将其注册到主线程池的其他 Reactor 线程上，由其负责接入认证，IP 黑白名单过滤，握手操作
 3. 步骤 2 完成之后，业务层的链路正式建立，将 SocketChanne 从主线程池的 Reactor 线程的多路复用移除，重新注册到 Sub 线程池的线程上，用于处理 IO 读写操作。